name: Quality Gates

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: BOM Scan (PHP/CSS)
      run: |
        echo "Checking for UTF-8 BOM in PHP and CSS files..."
        if find kunaal-theme -type f \( -name "*.php" -o -name "*.css" \) -print0 | xargs -0 grep -Il $'^\xEF\xBB\xBF'; then
          echo "✗ BOM characters found in files above"
          exit 1
        fi
        echo "✓ No BOM found"
    
    - name: PHP Lint
      run: |
        echo "Linting PHP files..."
        find kunaal-theme -name "*.php" -print0 | xargs -0 -n1 php -l
        echo "✓ PHP lint passed"
    
    - name: JavaScript Syntax Check
      run: |
        echo "Checking JavaScript syntax..."
        find kunaal-theme -name "*.js" -not -path "*/node_modules/*" -print0 | xargs -0 -n1 node --check
        echo "✓ JavaScript syntax check passed"
    
    - name: Check render.php for function declarations
      run: |
        echo "Checking render.php files for function declarations..."
        if grep -R "^function " kunaal-theme/blocks/*/render.php 2>/dev/null; then
          echo "✗ Found function declarations in render.php files"
          exit 1
        fi
        echo "✓ No function declarations in render.php"
    
    - name: Check for console.log in theme JS
      run: |
        echo "Checking for console.log in theme JavaScript..."
        # Match actual console.log calls, not comments or strings mentioning it
        # Matches: console.log( or console.log(
        if grep -rn --include="*.js" -E "console\.log\s*\(" kunaal-theme --exclude-dir=node_modules; then
          echo "✗ Found console.log() calls in theme JavaScript"
          echo "  (console.error and console.warn are allowed)"
          exit 1
        fi
        echo "✓ No console.log() calls found"
    
    - name: UI Contracts Check
      run: |
        echo "Running UI contracts drift check..."
        chmod +x kunaal-theme/scripts/check-ui-contracts.sh
        kunaal-theme/scripts/check-ui-contracts.sh
