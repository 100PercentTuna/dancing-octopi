name: Quality Gates

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: BOM Scan (PHP/CSS)
      run: |
        echo "Checking for UTF-8 BOM in PHP and CSS files..."
        if find kunaal-theme -type f \( -name "*.php" -o -name "*.css" \) -print0 | xargs -0 grep -Il $'^\xEF\xBB\xBF'; then
          echo "✗ BOM characters found in files above"
          exit 1
        fi
        echo "✓ No BOM found"
    
    - name: PHP Lint
      run: |
        echo "Linting PHP files..."
        find kunaal-theme -name "*.php" -print0 | xargs -0 -n1 php -l
        echo "✓ PHP lint passed"
    
    - name: JavaScript Syntax Check
      run: |
        echo "Checking JavaScript syntax..."
        find kunaal-theme -name "*.js" -not -path "*/node_modules/*" -print0 | xargs -0 -n1 node --check
        echo "✓ JavaScript syntax check passed"
    
    - name: Check render.php for function declarations
      run: |
        echo "Checking render.php files for function declarations..."
        if grep -R "^function " kunaal-theme/blocks/*/render.php 2>/dev/null; then
          echo "✗ Found function declarations in render.php files"
          exit 1
        fi
        echo "✓ No function declarations in render.php"
    
    - name: Check for console.log in theme JS
      run: |
        echo "Checking for console.log in theme JavaScript..."
        # Match actual console.log calls, not comments or strings mentioning it
        # Matches: console.log( or console.log(
        if grep -rn --include="*.js" -E "console\.log\s*\(" kunaal-theme --exclude-dir=node_modules; then
          echo "✗ Found console.log() calls in theme JavaScript"
          echo "  (console.error and console.warn are allowed)"
          exit 1
        fi
        echo "✓ No console.log() calls found"
    
    - name: UI Contracts Check
      run: |
        echo "Running UI contracts drift check..."
        chmod +x kunaal-theme/scripts/check-ui-contracts.sh
        kunaal-theme/scripts/check-ui-contracts.sh

    - name: Version Consistency Check
      run: |
        echo "Checking version consistency between style.css and functions.php..."
        STYLE_VERSION=$(grep -oP 'Version:\s*\K[\d.]+' kunaal-theme/style.css)
        FUNC_VERSION=$(grep -oP "define\('KUNAAL_THEME_VERSION',\s*'\K[\d.]+" kunaal-theme/functions.php)
        if [ "$STYLE_VERSION" != "$FUNC_VERSION" ]; then
          echo "✗ Version mismatch: style.css=$STYLE_VERSION, functions.php=$FUNC_VERSION"
          exit 1
        fi
        echo "✓ Version consistent: $STYLE_VERSION"

    - name: Duplicated Constant Check
      run: |
        echo "Checking for duplicated constant definitions..."
        # Check for KUNAAL_THEME_VERSION defined in multiple places (should only be in functions.php)
        DEFINE_COUNT=$(grep -r "define('KUNAAL_THEME_VERSION'" kunaal-theme --include="*.php" | wc -l)
        if [ "$DEFINE_COUNT" -gt 1 ]; then
          echo "✗ KUNAAL_THEME_VERSION defined in multiple files:"
          grep -r "define('KUNAAL_THEME_VERSION'" kunaal-theme --include="*.php"
          exit 1
        fi
        echo "✓ No duplicated constant definitions"

    - name: HTML Closure Check
      run: |
        echo "Checking for unclosed main tags in templates..."
        for file in kunaal-theme/*.php kunaal-theme/template-parts/*.php; do
          if [ -f "$file" ]; then
            MAIN_OPEN=$(grep -c '<main' "$file" 2>/dev/null || echo 0)
            MAIN_CLOSE=$(grep -c '</main>' "$file" 2>/dev/null || echo 0)
            if [ "$MAIN_OPEN" -gt 0 ] && [ "$MAIN_CLOSE" -lt "$MAIN_OPEN" ]; then
              echo "✗ Unclosed <main> tag in $file (opens: $MAIN_OPEN, closes: $MAIN_CLOSE)"
              exit 1
            fi
          fi
        done
        echo "✓ All main tags properly closed"

    - name: Secrets in Customizer Check
      run: |
        echo "Checking for secrets in Customizer..."
        if grep -rn "smtp_password\|api_key\|secret_key" kunaal-theme/inc/customizer-sections.php | grep -v "// "; then
          echo "✗ Found potential secret fields in Customizer (should be in wp-config.php)"
          exit 1
        fi
        echo "✓ No secrets stored in Customizer"
