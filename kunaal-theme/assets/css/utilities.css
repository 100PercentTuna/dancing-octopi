/* ========================================
   UTILITIES - Progress Bar, Lazy Loading, Animations
   ======================================== */

/* CSS Cascade Layers */
@layer tokens, base, utilities, components, blocks, pages;

@layer utilities {
/* ========================================
   PROGRESS BAR
   ======================================== */
.progress {
  position: fixed;
  top: 0;
  left: 0;
  height: 3px;
  width: 100%;
  z-index: 9999;
  pointer-events: none;
  background: rgba(30,90,255,0.1);
}
.progressFill {
  height: 100%;
  width: 0%;
  background: var(--blue);
  box-shadow: 0 0 10px rgba(30,90,255,.4);
  transition: width 250ms cubic-bezier(0.4, 0, 0.2, 1);
}

/* ========================================
   LAZY LOADING - Skeleton Placeholders
   ======================================== */
[data-lazy-block] {
  position: relative;
  min-height: 200px;
}

[data-lazy-block].is-loading {
  pointer-events: none;
}

[data-lazy-block].is-loading::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(
    90deg,
    var(--bg-alt) 25%,
    var(--bg) 50%,
    var(--bg-alt) 75%
  );
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s infinite;
  border-radius: 8px;
  z-index: 1;
}

@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

[data-lazy-block].is-loaded::before {
  display: none;
}

[data-lazy-block].is-error {
  border: 2px dashed var(--hair);
  padding: var(--space-4);
  text-align: center;
  color: var(--muted);
}

.lazy-block-error {
  padding: var(--space-3);
  background: var(--bg-alt);
  border: 1px solid var(--hair);
  border-radius: 6px;
  color: var(--muted);
  font-size: 14px;
}

@media (prefers-reduced-motion: reduce) {
  [data-lazy-block].is-loading::before {
    animation: none;
  }
}

/* ========================================
   LINK UNDERLINE MOTIF - CANONICAL IMPLEMENTATION
   (Single Source of Truth - see architecture.mdc)
   ======================================== */
  /**
   * LINK CONTRACT (site-wide):
   * - DEFAULT: no underline visible
   * - HOVER/FOCUS-VISIBLE: animated blue underline Lâ†’R
   * 
   * ALLOWED SELECTORS (only these may use link underline styling):
   * - .u-underline-double (explicit utility class)
   * - :where(.nav a, .footer a, .prose a, .articleMeta a, .mailWrap, .say-hello-text a)
   * - .is-style-double-underline (Gutenberg block style)
   * 
   * NO OTHER FILE may implement link underlines. If you need underline behavior
   * on a new element, ADD IT to the :where() selector list here.
   * 
   * Token-driven implementation:
   * - Blue line via background gradient (no text-decoration)
   * - Works on inline links and spans
   * - Supports multi-line wrapping with box-decoration-break
   * - Maintains accessible focus states
   */
  .u-underline-double {
    display: inline;
    text-decoration: none; /* No underline at rest */
    background-image: linear-gradient(
      var(--k-underline-blue-color, var(--blue)),
      var(--k-underline-blue-color, var(--blue))
    );
    background-repeat: no-repeat;
    background-position: 0 calc(100% + var(--k-underline-blue-offset, -1px));
    background-size: 0% var(--k-underline-blue-thickness, 2px);
    padding-bottom: calc(var(--k-underline-blue-thickness, 2px) + 1px);
    box-decoration-break: clone;
    transition: background-size 280ms cubic-bezier(0.4, 0, 0.2, 1) 40ms;
  }

  .u-underline-double:hover,
  .u-underline-double:focus-visible {
    background-size: 100% var(--k-underline-blue-thickness, 2px);
  }

  /* ========================================
     GLOBAL LINK UNDERLINE - ANIMATED LEFT-TO-RIGHT
     ========================================
     Strategy: Apply to ALL links globally with opt-out exclusions.
     Animation: Blue underline animates from 0% to 100% width (left to right)
     
     EXCLUDED ELEMENTS (opt-out):
     - Buttons: [class*="button"], [class*="btn"]
     - Cards: .card, .capsule, .media-item, .inspiration-item
     - Special elements: .u-link-plain, .skip-link
     - Image-related: Links containing only images
     ======================================== */
  :where(
    a:not([class*="button"]):not([class*="btn"]):not(.card):not(.capsule):not(.media-item):not(.inspiration-item):not(.u-link-plain):not(.skip-link):not(.tTitle):not(:has(> img:only-child)):not(.jRow):not(:has(.subtitle))
  ) {
    display: inline;
    text-decoration: none; /* No underline at rest */
    background-image: linear-gradient(
      var(--k-underline-blue-color, var(--blue)),
      var(--k-underline-blue-color, var(--blue))
    );
    background-repeat: no-repeat;
    /* Position at bottom, offset slightly for visual clarity */
    background-position: 0 calc(100% + var(--k-underline-blue-offset, -1px));
    /* Start with 0% width - this is the key to L-to-R animation */
    background-size: 0% var(--k-underline-blue-thickness, 2px);
    padding-bottom: calc(var(--k-underline-blue-thickness, 2px) + 1px);
    box-decoration-break: clone;
    /* Animation: ease-out cubic for smooth L-to-R motion */
    transition: background-size 280ms cubic-bezier(0.4, 0, 0.2, 1) 40ms;
  }

  /* Hover/focus: underline animates to 100% width (left-to-right reveal) */
  :where(
    a:not([class*="button"]):not([class*="btn"]):not(.card):not(.capsule):not(.media-item):not(.inspiration-item):not(.u-link-plain):not(.skip-link):not(.tTitle):not(:has(> img:only-child)):not(.jRow):not(:has(.subtitle))
  ):hover,
  :where(
    a:not([class*="button"]):not([class*="btn"]):not(.card):not(.capsule):not(.media-item):not(.inspiration-item):not(.u-link-plain):not(.skip-link):not(.tTitle):not(:has(> img:only-child)):not(.jRow):not(:has(.subtitle))
  ):focus-visible {
    background-size: 100% var(--k-underline-blue-thickness, 2px);
  }

  /* Opt-out utility class - use on links that should NOT have animated underline */
  .u-link-plain {
    background-image: none !important;
    padding-bottom: 0 !important;
  }

  /* Nav-specific enhancements - letter spacing on hover for visual polish */
  .nav a:hover,
  .nav a:focus-visible,
  .nav a.current {
    letter-spacing: .01em;
  }

  /* Block style class mapping (for Gutenberg block styles) */
  .is-style-double-underline {
    display: inline;
    text-decoration: none; /* No underline at rest */
    background-image: linear-gradient(
      var(--k-underline-blue-color, var(--blue)),
      var(--k-underline-blue-color, var(--blue))
    );
    background-repeat: no-repeat;
    background-position: 0 calc(100% + var(--k-underline-blue-offset, -1px));
    background-size: 100% var(--k-underline-blue-thickness, 2px);
    padding-bottom: calc(var(--k-underline-blue-thickness, 2px) + 1px);
    box-decoration-break: clone;
  }


  /* ========================================
     SECTION HEADER RULE - CANONICAL IMPLEMENTATION
     (Single Source of Truth - see architecture.mdc)
     ========================================
     SECTION RULE CONTRACT:
     - Gray line: 1px border-bottom on .sectionHead container (in sections.css)
     - Blue segment: 3px ::after pseudo-element on heading (here)
     
     Usage: <div class="sectionHead"><h2 class="u-section-underline">Title</h2></div>
     
     NO OTHER FILE may draw section rules. This is the only implementation.
     ======================================== */
  .u-section-underline {
    position: relative;
    padding-bottom: 8px;
    /* No border-bottom here - gray line is on .sectionHead container */
  }

  .u-section-underline::after {
    content: "";
    position: absolute;
    left: 0;
    /* Position blue segment to OVERLAP the gray border on parent .sectionHead
       The gray border is on .sectionHead which has padding-bottom: var(--space-1) = 8px
       So the gray border is 8px below the h2's bottom edge.
       To center 3px blue on 1px gray: bottom of blue = gray center - blue half height
       Gray center = 8px + 0.5px = 8.5px below h2 bottom
       Blue bottom = 8.5px - 1.5px = 7px below h2 bottom = bottom: -7px
       But CSS bottom is relative to containing block's bottom edge, so: */
    bottom: -9px; /* Extends to overlap the gray border on parent .sectionHead */
    width: 30px; /* Short blue segment */
    height: 3px; /* Thicker than gray line (1px vs 3px) */
    background: var(--k-underline-blue-color, var(--blue));
    border-radius: 1.5px; /* Rounded ends (half of height for pill shape) */
    transform-origin: left;
    transform: scaleX(0);
    animation: growLine 600ms ease 350ms forwards;
    z-index: 2; /* Ensure blue line is above the gray border */
  }

  @keyframes growLine {
    from { transform: scaleX(0); }
    to { transform: scaleX(1); }
  }

  /* Dark mode: section underline uses bright orange accent */
  :root[data-theme="dark"] .u-section-underline::after {
    background: var(--k-color-dark-accent, #E8A87C);
  }
  
  /* Dark mode: section title text should be light */
  :root[data-theme="dark"] .u-section-underline,
  :root[data-theme="dark"] h2.u-section-underline,
  :root[data-theme="dark"] h3.u-section-underline {
    color: #f0f0f0 !important;
  }

  /* ========================================
     DEPRECATED: .uBlue - Remove after 2025-03-01
     Use .u-underline-double or add element to :where() selector above
     ======================================== */
  .uBlue {
    display: inline;
    text-decoration: none; /* No underline at rest */
    background-image: linear-gradient(
      var(--k-underline-blue-color, var(--blue)),
      var(--k-underline-blue-color, var(--blue))
    );
    background-repeat: no-repeat;
    background-position: 0 calc(100% + var(--k-underline-blue-offset, -1px));
    background-size: 0% var(--k-underline-blue-thickness, 2px);
    padding-bottom: calc(var(--k-underline-blue-thickness, 2px) + 1px);
    box-decoration-break: clone;
    transition: background-size 280ms cubic-bezier(0.4, 0, 0.2, 1) 40ms;
  }
  .uBlue:hover, 
  .uBlue:focus-visible, 
  .uBlue.current {
    background-size: 100% var(--k-underline-blue-thickness, 2px);
    letter-spacing: .01em;
  }

/* ========================================
   SCREEN READER ONLY
   ======================================== */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  white-space: nowrap;
  border: 0;
}
} /* End utilities layer */

