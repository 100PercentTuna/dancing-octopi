/* ========================================
   HEADER - Fixed with backdrop blur
   ======================================== */

@layer components {
.mast {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 9998; /* Below progress bar (9999), above all content */
  background: rgba(253,252,250,.95);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--hair2);
  transform: translateZ(0);
  isolation: isolate;
  /* Ensure header stays fixed even on very narrow screens */
  width: 100%;
  max-width: 100vw;
  box-sizing: border-box;
}

/* ========================================
   DARK MODE - Masthead & Navigation
   Uses token-based colors from tokens.css
   
   NOTE: Nav link underline animation is handled by utilities.css
   using --k-underline-blue-color (orange in dark mode via tokens.css)
   ======================================== */
:root[data-theme="dark"] .mast {
  background: var(--k-color-bg); /* Token-based, 100% opaque */
  border-bottom-color: var(--k-color-hair);
}

/* Dark mode nav links - text color + ensure transparent background */
:root[data-theme="dark"] .mast .nav a,
:root[data-theme="dark"] .nav a {
  color: var(--k-color-ink);
  background-color: transparent; /* CRITICAL: No solid background, only gradient underline */
}

/* Dark mode nav toggle */
:root[data-theme="dark"] .mast .navToggle,
:root[data-theme="dark"] .navToggle {
  color: var(--k-color-ink);
}

/* Mobile nav dropdown in dark mode */
:root[data-theme="dark"] .mast .nav,
:root[data-theme="dark"] .nav {
  background: var(--k-color-bg);
  border-color: var(--k-color-hair);
}

/* Ensure header stays fixed on all screen sizes */
@media (max-width: 640px) {
  .mast {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    width: 100%;
    max-width: 100vw;
  }
}

.mastInner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-3);
  padding-top: calc(var(--space-2) - (6px * var(--p)));
  padding-bottom: calc(var(--space-2) - (6px * var(--p)));
  /* No padding-left/right - inherits from .container */
}

/* Navigation and controls container - equal spacing */
.mastInner > .nav {
  margin-left: auto;
  margin-right: var(--space-3);
}

/* Controls wrapper for nav toggle + theme toggle */
.mastControls {
  display: flex;
  align-items: center;
  gap: 10px;
}

.mastInner > .mastControls {
  margin-left: 16px; /* Fixed gap from menu, not auto */
}

.mastControls > .theme-toggle {
  margin-top: 0; /* Remove offset - use same baseline as nav */
  align-self: center;
  display: flex;
  align-items: center;
  justify-content: center;
  /* Match nav padding-top to ensure exact vertical alignment */
  padding-top: 2px;
  line-height: 1;
  /* Ensure same vertical baseline as nav items */
  vertical-align: baseline;
}

/* Legacy selector for backward compatibility */
.mastInner > .theme-toggle {
  margin-left: 16px;
  margin-top: 0;
  align-self: center;
  display: flex;
  align-items: center;
  justify-content: center;
  padding-top: 2px;
  line-height: 1;
  vertical-align: baseline;
}
@media (max-width: 640px) {
  /* Mobile theme toggle: smaller, snug to menu, no box styling */
  .mastInner {
    /* Ensure proper alignment */
    align-items: center;
    gap: 12px; /* Reduce gap for snug fit */
    justify-content: space-between; /* Brand left, controls right */
  }
  
  .mastInner > .nav {
    margin-right: 6px; /* Smaller gap - snug to controls */
    margin-left: 0;
    order: 2; /* Nav comes before controls */
  }
  
  .mastInner > .mastControls {
    margin-left: 0;
    margin-right: 0; /* Rightmost element */
    order: 3; /* Ensure it's last (rightmost) */
    gap: 8px; /* Tighter gap between buttons */
  }
  
  .mastControls > .navToggle,
  .mastControls > .theme-toggle {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    box-shadow: none;
    padding: 0;
    /* Ensure same vertical alignment */
    align-self: center;
    display: flex;
    align-items: center;
    justify-content: center;
    /* Match nav vertical alignment exactly */
    line-height: 1;
    vertical-align: middle;
  }
  
  /* Legacy selector for backward compatibility */
  .mastInner > .theme-toggle {
    width: 32px;
    height: 32px;
    margin-left: 0;
    margin-right: 0;
    order: 3;
    border: none;
    background: transparent;
    box-shadow: none;
    padding: 0;
    align-self: center;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    vertical-align: middle;
  }
  .theme-toggle-icon {
    width: 16px;
    height: 16px;
  }
  .theme-toggle:hover,
  .theme-toggle:focus-visible {
    background: transparent;
    transform: none;
    box-shadow: none;
  }
}

.brand {
  display: flex;
  gap: calc(12px - (4px * var(--p)));
  min-width: 0;
  align-items: center;
  text-decoration: none;
}

/* Avatar */
.avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 1px solid var(--hair);
  background: #fff;
  overflow: hidden;
  flex: 0 0 auto;
}
.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  filter: grayscale(calc(var(--p) * 0.85));
  transition: transform 220ms cubic-bezier(0.4,0,0.2,1), filter 220ms ease;
  --ps: 1;
  transform: scale(var(--ps));
}
/* Override grayscale on hover - use higher specificity */
.avatar:hover img,
.avatar[data-hover="true"] img {
  filter: grayscale(0);
  --ps: 1.06;
  cursor: pointer;
}

/* Initials fallback */
.avatar.noImg {
  display: grid;
  place-items: center;
  background: linear-gradient(135deg, var(--blueTint), color-mix(in srgb, var(--ink) 2%, transparent));
}
.avatar.noImg::after {
  content: attr(data-initials);
  font-family: var(--sans);
  font-weight: 650;
  letter-spacing: -.03em;
  color: var(--muted);
  font-size: 15px;
}

.nameWrap { min-width: 0; }

/* Name with color transition on scroll */
.nameLine {
  display: flex;
  align-items: baseline;
  gap: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin: 0;
  font-family: var(--serif);
  font-weight: 600;
  letter-spacing: -.02em;
  font-size: calc(20px - (4px * var(--p)));
  line-height: 1.2;
  /* Dynamic color: blue when scrolled up, ink when scrolled down */
  color: color-mix(in srgb, var(--blue) calc((1 - var(--p)) * 100%), var(--ink));
}
.nameLine .surname { font-weight: 600; }

.subtitle {
  margin: 1px 0 0;
  color: var(--muted);
  max-width: 78ch;
  font-size: calc(12px - (2px * var(--p)));
  opacity: calc(1 - (0.5 * var(--p)));
  white-space: pre-line; /* Preserve newlines from admin input */
  /* Disable underline animation on hover */
  background-image: none;
  padding-bottom: 0;
  line-height: 1.4;
  text-shadow: 0 0 20px var(--bg);
}

/* Nav - Desktop */
.nav {
  display: flex;
  gap: var(--space-3);
  align-items: center;
  padding-top: 2px;
}
/* Nav links - explicit underline animation setup
   Uses token-based colors: --k-underline-blue-color (orange in dark mode, blue fallback in light)
   IMPORTANT: 
   - display: inline-block fixes background-size issues on Edge (inline has different behavior)
   - background-color: transparent prevents any solid fill */
.nav a {
  font-size: 12.5px;
  color: var(--muted);
  padding: 8px 0;
  position: relative;
  display: inline-block; /* CRITICAL for Edge: inline-block makes background-size work correctly */
  /* Underline animation setup - ALL properties explicit to override utilities.css */
  text-decoration: none;
  background-color: transparent; /* Explicit - no solid background */
  background-image: linear-gradient(
    var(--k-underline-blue-color, var(--blue)),
    var(--k-underline-blue-color, var(--blue))
  );
  background-repeat: no-repeat;
  background-position: 0 100%; /* Bottom of element */
  background-size: 0% 2px; /* Hidden by default - 0% width, 2px height */
  transition: background-size 280ms cubic-bezier(0.4, 0, 0.2, 1) 40ms;
}

/* Hover/focus: underline animates L-to-R */
.nav a:hover,
.nav a:focus-visible {
  color: var(--muted);
  background-color: transparent; /* Ensure no background fill on hover */
  background-size: 100% 2px; /* Full width, 2px height - THIS IS THE UNDERLINE */
}

/* Current item: underline visible at full width */
.nav a.current {
  color: var(--muted);
  background-color: transparent; /* Ensure no background fill when current */
  background-size: 100% 2px; /* Full width, 2px height - THIS IS THE UNDERLINE */
}

/* Mobile nav toggle */
.navToggle {
  display: none;
  background: none;
  border: none;
  padding: 8px;
  cursor: pointer;
  color: var(--muted);
}
.navToggle:focus-visible {
  outline: 2px solid var(--blue);
  outline-offset: 2px;
  border-radius: 4px;
}
.navToggle svg { width: 20px; height: 20px; }

/* Theme toggle button - matches share/subscribe button aesthetic */
.theme-toggle {
  width: 40px;
  height: 40px;
  border: 1px solid var(--hair);
  background: var(--bg);
  border-radius: 4px;
  display: grid;
  place-items: center;
  cursor: pointer;
  color: var(--muted);
  position: relative;
  transition: all 200ms ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  padding: 0;
}

.theme-toggle:hover,
.theme-toggle:focus-visible { 
  border-color: var(--blueStroke); 
  color: var(--blue);
  background: var(--blueTint);
  box-shadow: 0 4px 12px rgba(30,90,255,0.12);
  transform: translateY(-2px);
  outline: 2px solid var(--blue);
  outline-offset: 2px;
}

.theme-toggle-icon {
  width: 18px;
  height: 18px;
  stroke: currentColor;
  fill: none;
  display: block;
}

.theme-toggle-icon-sun {
  display: none;
}

/* Screen reader only */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

@media (max-width: 760px) {
  .nav {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--bg);
    border: 1px solid var(--hair2);
    border-radius: 8px;
    padding: var(--space-2);
    flex-direction: column;
    gap: 4px;
    box-shadow: 0 8px 30px rgba(0,0,0,.12);
    min-width: 160px;
  }
  .nav.open { display: flex; }
  .nav a {
    padding: 10px 16px;
    border-radius: 6px;
    display: block; /* Block display in mobile dropdown */
  }
  /* Mobile hover: underline animates L-to-R */
  .nav a:hover,
  .nav a:focus-visible {
    background-size: 100% 2px;
  }
  /* Mobile current: underline visible */
  .nav a.current {
    background-size: 100% 2px;
  }
  .navToggle { display: block; }
  .mastInner { position: relative; }
  .subtitle { display: none; }
}

} /* End @layer components */

